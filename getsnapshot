#!/bin/sh

download() {
    echo 'Servers available:'

    PS3='Choose a server: '
    select server in $servers; do
        if [ $server ]; then
            ftp -V \
                ${server}/snapshots/$arch/INSTALL.$arch \
                ${server}/snapshots/$arch/SHA256 \
                ${server}/snapshots/$arch/SHA256.sig \
                ${server}/snapshots/$arch/bsd \
                ${server}/snapshots/$arch/bsd.mp \
                ${server}/snapshots/$arch/bsd.rd \
                ${server}/snapshots/$arch/base${rel}.tgz \
                ${server}/snapshots/$arch/comp${rel}.tgz \
                ${server}/snapshots/$arch/game${rel}.tgz \
                ${server}/snapshots/$arch/man${rel}.tgz \
                ${server}/snapshots/$arch/xbase${rel}.tgz \
                ${server}/snapshots/$arch/xfont${rel}.tgz \
                ${server}/snapshots/$arch/xserv${rel}.tgz \
                ${server}/snapshots/$arch/xshare${rel}.tgz
            break
        else
            echo 'invalid selection'
        fi
    done
}

# download and parse mirrors list
servers=$(ftp -o - http://www.openbsd.org/build/mirrors.dat | grep -e ^UH | sed 's/^UH[[:space:]]*//')

# filter snapshot release (no wildcards with http in ftp(1))
arch=$(machine -a)
index="http://ftp.openbsd.org/pub/OpenBSD/snapshots/${arch}/index.txt"
ftp -V $index
rel=$(cat index.txt | grep comp | awk '{ print $10 }' | sed 's/comp//; s/\..*//')

download
